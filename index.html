<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mission Control Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#27ae60">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #27ae60; 
            --secondary: #2ecc71;
            --overdue: #e74c3c;
            --bg-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            --glass: rgba(255, 255, 255, 0.95);
            --text: #2d3436; 
            --cat-work: #0984e3; --cat-home: #6c5ce7; --cat-personal: #00b894; --cat-urgent: #d63031;
        }
        
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; color: var(--text); overflow-x: hidden; }

        .logout-btn { position: fixed; top: 20px; right: 20px; background: white; color: var(--overdue); border: 2px solid var(--overdue); padding: 8px 15px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; z-index: 100; font-size: 12px; }

        #auth-screen { display: flex; height: 100vh; width: 100%; background: var(--bg-gradient); flex-direction: column; align-items: center; justify-content: center; }
        .auth-card { background: var(--glass); padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); width: 340px; text-align: center; }
        .auth-input-container { position: relative; width: 100%; margin-bottom: 15px; }
        .auth-input { width: 100%; padding: 14px; padding-right: 70px; border-radius: 12px; border: 2px solid #ddd; background: #fff; outline: none; box-sizing: border-box; }
        
        .pass-toggle-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #f1f2f6; border: 1px solid #ddd; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; color: #636e72; text-transform: uppercase; }

        .btn-login { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: 600; cursor: pointer; text-transform: uppercase; }

        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: 0.8s; }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        #app-dashboard { display: none; padding: 20px; max-width: 1200px; margin: auto; padding-top: 60px; }
        
        .analytics-container { background: white; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; }
        .analytics-header { background: var(--primary); color: white; padding: 10px 20px; font-weight: 600; text-align: center; font-size: 18px; }
        .analytics-content { display: flex; padding: 25px; align-items: flex-end; gap: 30px; }
        
        .y-axis { display: flex; flex-direction: column; justify-content: space-between; height: 150px; padding-bottom: 25px; color: #636e72; font-size: 11px; width: 30px; }
        .chart-area { flex-grow: 1; display: flex; justify-content: space-between; align-items: flex-end; height: 150px; border-bottom: 2px solid #dfe6e9; padding: 0 10px; position: relative; }
        
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; z-index: 1; max-width: 50px; }
        .bar-track { width: 30px; background: #f1f2f6; border-radius: 15px 15px 0 0; position: relative; height: 150px; overflow: hidden; }
        
        .bar-planned, .bar-done { 
            width: 100%; position: absolute; bottom: 0; border-radius: 12px 12px 0 0; height: 0; 
            transition: height 1.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .bar-planned { background: var(--primary); opacity: 0.15; }
        .bar-done { 
            background: linear-gradient(to top, var(--primary), var(--secondary));
            animation: liquidSway 4s ease-in-out infinite;
        }

        @keyframes liquidSway {
            0%, 100% { border-radius: 12px 12px 0 0; }
            50% { border-radius: 18px 8px 0 0; }
        }

        .day-label { font-size: 11px; font-weight: 600; margin-top: 10px; color: #2d3436; }

        .progress-container { position: relative; width: 100px; height: 100px; }
        .progress-ring { transform: rotate(-90deg); }
        .pct-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 22px; font-weight: 600; }

        .view-toggle { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .view-btn { padding: 8px 25px; border-radius: 20px; border: 2px solid var(--primary); background: transparent; color: var(--primary); cursor: pointer; font-weight: 600; transition: 0.3s; }
        .view-btn.active { background: var(--primary); color: white; }

        .category-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 5px; }
        .cat-tab { padding: 8px 18px; border-radius: 12px; background: white; border: none; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap; }
        .cat-tab.active { background: #34495e; color: white; }

        .input-bar { background: white; padding: 20px; border-radius: 20px; display: grid; grid-template-columns: 2fr 1.2fr 1.1fr 1fr auto; gap: 12px; margin-bottom: 25px; border-bottom: 4px solid var(--primary); }
        .board { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 20px; }
        .col { background: #ebedef; padding: 18px; border-radius: 24px; min-height: 400px; }
        li { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; border-left: 6px solid var(--primary); }

        /* --- MOBILE UI OVERRIDES (Targeting Screenshot Issues) --- */
        @media (max-width: 768px) {
            .analytics-content { gap: 10px; padding: 15px; }
            .y-axis { width: 20px; font-size: 10px; }
            .chart-area { padding: 0 5px; }
            .bar-track { width: 20px; }
            .day-label { font-size: 9px; transform: rotate(-30deg); margin-top: 12px; }
            .input-bar { grid-template-columns: 1fr; }
            .board { grid-template-columns: 1fr; }
            .logout-btn { top: 10px; right: 10px; padding: 6px 10px; }
        }
    </style>
</head>
<body>

    <div id="splash-screen"><h2>MISSION CONTROL PRO</h2></div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 id="auth-title">Login</h2>
            <div class="auth-input-container"><input type="text" id="username" class="auth-input" placeholder="Username"></div>
            <div class="auth-input-container">
                <input type="password" id="password" class="auth-input" placeholder="Password">
                <button type="button" class="pass-toggle-btn" id="togglePassBtn" onclick="togglePassword()">Show</button>
            </div>
            <button id="authBtn" class="btn-login" onclick="handleAuth()">LOGIN</button>
            <p id="auth-error" style="color:var(--overdue); margin-top:10px; font-size:12px;"></p>
            <p id="toggle-text" style="font-size:12px; margin-top:15px;">New user? <span onclick="toggleAuthMode()" style="color:var(--primary); cursor:pointer; font-weight: 600;">Sign Up</span></p>
        </div>
    </div>

    <div id="app-dashboard">
        <button class="logout-btn" onclick="logout()">SIGN OUT</button>

        <div class="analytics-container">
            <div class="analytics-header">Weekly Fuel Levels</div>
            <div class="analytics-content">
                <div class="y-axis"><span id="y-max">8</span><span>6</span><span>4</span><span>2</span><span>0</span></div>
                <div class="chart-area" id="weeklyChart"></div>
                <div class="side-meter">
                    <div class="progress-container">
                        <svg class="progress-ring" width="100" height="100">
                            <circle stroke="#f1f2f6" stroke-width="10" fill="transparent" r="42" cx="50" cy="50"/>
                            <circle id="progressCircle" stroke="var(--primary)" stroke-width="10" fill="transparent" r="42" cx="50" cy="50" style="stroke-dasharray: 264; stroke-dashoffset: 264;"/>
                        </svg>
                        <div id="pctLabel" class="pct-label">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-toggle">
            <button id="view-active" class="view-btn active" onclick="setView('active')">ACTIVE</button>
            <button id="view-archived" class="view-btn" onclick="setView('archived')">ARCHIVE</button>
        </div>

        <div class="category-bar">
            <button class="cat-tab active" onclick="setCategory('all')">ALL</button>
            <button class="cat-tab" onclick="setCategory('work')">WORK</button>
            <button class="cat-tab" onclick="setCategory('home')">HOME</button>
            <button class="cat-tab" onclick="setCategory('personal')">PERSONAL</button>
            <button class="cat-tab" onclick="setCategory('urgent')">URGENT</button>
        </div>

        <div class="input-bar" id="inputBarContainer">
            <input type="text" id="taskName" placeholder="Mission Name...">
            <select id="taskCat"><option value="work">Work</option><option value="home">Home</option><option value="personal">Personal</option><option value="urgent">Urgent</option></select>
            <input type="date" id="taskDate">
            <input type="time" id="taskTime">
            <button onclick="addTask()">DEPLOY</button>
        </div>

        <div class="board">
            <div class="col"><h3>‚è≥ PREVIOUS</h3><ul id="list-prev"></ul></div>
            <div class="col"><h3>üöÄ TODAY</h3><ul id="list-today"></ul></div>
            <div class="col"><h3>üìÖ UPCOMING</h3><div id="up-cont"></div></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA-mhIz79hzRvTbVZKeDPEfv2uv5jh-iSA",
        authDomain: "task-list-tracker-e80d4.firebaseapp.com",
        databaseURL: "https://task-list-tracker-e80d4-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "task-list-tracker-e80d4",
        appId: "1:918246411240:web:3f448eb1d0a6fc3f4fb25d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null, allTasks = [], currentCategory = 'all', currentView = 'active', isLoginMode = true;

    // RESTRICT PREVIOUS DATES
    const getTodayStr = () => new Date().toLocaleDateString('en-CA');
    document.getElementById('taskDate').min = getTodayStr();

    // --- PWA AUTO-UPDATE LOGIC ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if (confirm("New update available! Refresh now?")) window.location.reload();
                        }
                    };
                };
            });
        });
    }

    onAuthStateChanged(auth, (user) => {
        document.getElementById('splash-screen').classList.add('hidden');
        if (user) { currentUser = user; document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-dashboard').style.display = 'block'; loadData(); }
        else { document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('app-dashboard').style.display = 'none'; }
    });

    window.togglePassword = () => {
        const p = document.getElementById('password'), b = document.getElementById('togglePassBtn');
        p.type = p.type === 'password' ? 'text' : 'password';
        b.innerText = p.type === 'password' ? 'Show' : 'Hide';
    };

    window.handleAuth = async () => {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        const email = `${u}@missioncontrol.com`;
        try {
            if (isLoginMode) await signInWithEmailAndPassword(auth, email, p);
            else await createUserWithEmailAndPassword(auth, email, p);
        } catch (e) { document.getElementById('auth-error').innerText = e.message; }
    };

    window.toggleAuthMode = () => { isLoginMode = !isLoginMode; document.getElementById('auth-title').innerText = isLoginMode ? "Login" : "Sign Up"; };
    window.logout = () => signOut(auth);

    window.setView = (view) => { currentView = view; renderUI(); };
    window.setCategory = (cat) => { currentCategory = cat; renderUI(); };

    function loadData() {
        onValue(ref(db, `users/${currentUser.uid}/tasks`), (snap) => {
            const data = snap.val();
            allTasks = data ? Object.keys(data).map(k => ({id: k, ...data[k]})) : [];
            renderUI();
        });
    }

    window.addTask = () => {
        const n = document.getElementById('taskName').value, d = document.getElementById('taskDate').value, c = document.getElementById('taskCat').value;
        if(!n || !d) return alert("Required fields missing.");
        set(ref(db, `users/${currentUser.uid}/tasks/${Date.now()}`), { name: n, cat: c, date: d, completed: false, archived: false });
        document.getElementById('taskName').value = '';
    };

    window.toggleTask = (id, cur) => update(ref(db, `users/${currentUser.uid}/tasks/${id}`), { completed: !cur });
    window.archiveTask = (id, cur) => update(ref(db, `users/${currentUser.uid}/tasks/${id}`), { archived: !cur });
    window.deleteTask = (id) => remove(ref(db, `users/${currentUser.uid}/tasks/${id}`));

    function renderUI() {
        const todayStr = getTodayStr();
        const sun = new Date(); sun.setDate(sun.getDate() - sun.getDay());
        const sunStr = sun.toLocaleDateString('en-CA');

        const prev = document.getElementById('list-prev'), now = document.getElementById('list-today'), up = document.getElementById('up-cont');
        prev.innerHTML = now.innerHTML = up.innerHTML = '';

        let filtered = allTasks.filter(t => currentView === 'archived' ? t.archived : !t.archived);
        if (currentCategory !== 'all') filtered = filtered.filter(t => t.cat === currentCategory);

        const stats = [0,0,0,0,0,0,0], doneStats = [0,0,0,0,0,0,0];
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        filtered.forEach(t => {
            const li = document.createElement('li'); li.style.borderLeftColor = `var(--cat-${t.cat})`;
            li.innerHTML = `<div><input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask('${t.id}',${t.completed})"><span>${t.name}</span></div>
                            <div><button onclick="archiveTask('${t.id}',${t.archived})">${t.archived?'üì§':'üì•'}</button><button onclick="deleteTask('${t.id}')">√ó</button></div>`;
            if (t.date < todayStr) prev.appendChild(li); else if (t.date === todayStr) now.appendChild(li); else up.appendChild(li);

            const tDate = new Date(t.date + 'T00:00:00');
            const diff = Math.round((tDate - new Date(sunStr + 'T00:00:00')) / 86400000);
            if(diff >= 0 && diff < 7) { stats[diff]++; if(t.completed) doneStats[diff]++; }
        });

        const chart = document.getElementById('weeklyChart'); chart.innerHTML = '';
        const max = Math.max(...stats, 8); document.getElementById('y-max').innerText = max;
        days.forEach((day, i) => {
            chart.innerHTML += `<div class="bar-wrapper"><div class="bar-track"><div class="bar-planned" style="height:${(stats[i]/max)*100}%"></div><div class="bar-done" style="height:${(doneStats[i]/max)*100}%"></div></div><div class="day-label">${day}</div></div>`;
        });

        const total = filtered.length, done = filtered.filter(t => t.completed).length;
        const pct = total ? (done/total)*100 : 0;
        document.getElementById('progressCircle').style.strokeDashoffset = 264 - (pct/100*264);
        document.getElementById('pctLabel').innerText = Math.round(pct) + "%";
    }
</script>
</body>
</html>
