<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mission Control Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#27ae60">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #27ae60; 
            --secondary: #2ecc71;
            --primary-shadow: #219150;
            --overdue: #e74c3c;
            --bg-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            --glass: rgba(255, 255, 255, 0.95);
            --text: #2d3436; 
            --bg-main: #f0f2f5;
            --card-bg: #ffffff;
            --col-bg: #ebedef;
            --border: #dfe6e9;
            --cat-work: #0984e3; --cat-home: #6c5ce7; --cat-personal: #00b894; --cat-urgent: #d63031;
        }

        [data-theme="dark"] {
            --primary: #2ecc71; 
            --secondary: #55efc4;
            --primary-shadow: #1b9e53;
            --bg-gradient: linear-gradient(135deg, #1b9e53 0%, #2ecc71 100%);
            --bg-main: #121212;
            --card-bg: #1e1e1e;
            --text: #f5f6fa;
            --glass: rgba(30, 30, 30, 0.95);
            --col-bg: #252525;
            --border: #333333;
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--bg-main); 
            margin: 0; 
            color: var(--text); 
            overflow-x: hidden; 
            transition: background 0.3s, color 0.3s;
        }

        [data-theme="dark"] input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        
        input[type="date"], input[type="time"] {
            accent-color: var(--primary);
        }

        .top-nav {
            position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 1000;
        }

        .btn-header {
            padding: 8px 15px; border-radius: 12px; font-weight: 600; font-size: 12px;
            cursor: pointer; transition: 0.3s; border: 2px solid; text-transform: uppercase;
            background: var(--card-bg); color: var(--text); border-color: var(--border);
        }

        #install-btn { background: #2d3436; color: white; border-color: #2d3436; display: none; }
        
        .logout-btn { color: var(--overdue); border-color: var(--overdue); }
        .logout-btn:hover { background: var(--overdue); color: white; }

        #auth-screen { display: flex; height: 100vh; width: 100%; background: var(--bg-gradient); flex-direction: column; align-items: center; justify-content: center; }
        .auth-card { background: var(--glass); padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); width: 340px; text-align: center; }
        .auth-input-container { position: relative; width: 100%; margin-bottom: 15px; }
        .auth-input { width: 100%; padding: 14px; padding-right: 70px; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text); outline: none; box-sizing: border-box; }
        
        .pass-toggle-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: var(--col-bg); border: 1px solid var(--border); padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; color: var(--text); }

        .btn-login { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: 600; cursor: pointer; text-transform: uppercase; }

        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: 0.8s; }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        #app-dashboard { display: none; padding: 20px; max-width: 1200px; margin: auto; padding-top: 80px; }
        
        .analytics-container { background: var(--card-bg); border-radius: 12px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; }
        .analytics-header { background: var(--primary); color: white; padding: 10px 20px; font-weight: 600; text-align: center; font-size: 18px; transition: background 0.3s; }
        .analytics-content { display: flex; padding: 25px; align-items: flex-end; gap: 30px; }
        
        .y-axis { display: flex; flex-direction: column; justify-content: space-between; height: 150px; padding-bottom: 25px; color: var(--text); opacity: 0.7; font-size: 11px; width: 30px; }
        .chart-area { flex-grow: 1; display: flex; justify-content: space-between; align-items: flex-end; height: 150px; border-bottom: 2px solid var(--border); padding: 0 10px; position: relative; }
        
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; z-index: 1; max-width: 50px; }
        .bar-track { width: 30px; background: var(--col-bg); border-radius: 15px 15px 0 0; position: relative; height: 150px; overflow: hidden; }
        
        .bar-planned, .bar-done { 
            width: 100%; position: absolute; bottom: 0; border-radius: 12px 12px 0 0; height: 0; 
            transition: height 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .bar-planned { background: var(--primary); opacity: 0.15; }
        .bar-done { background: linear-gradient(to top, var(--primary), var(--secondary)); z-index: 2; }

        .day-label { font-size: 11px; font-weight: 600; margin-top: 10px; color: var(--text); }

        .progress-container { position: relative; width: 100px; height: 100px; }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring-bg { stroke: var(--col-bg); }
        #progressCircle { stroke: var(--primary); transition: stroke-dashoffset 0.8s ease-in-out, stroke 0.3s; }
        .pct-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 22px; font-weight: 600; }

        .view-toggle { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .view-btn { padding: 8px 25px; border-radius: 20px; border: 2px solid var(--primary); background: transparent; color: var(--primary); cursor: pointer; font-weight: 600; transition: 0.3s; }
        .view-btn.active { background: var(--primary); color: white; }

        .category-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 5px; }
        .cat-tab { padding: 8px 18px; border-radius: 12px; background: var(--card-bg); color: var(--text); border: 1px solid var(--border); cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap; transition: 0.3s; }
        .cat-tab.active { background: #34495e !important; color: white !important; }

        .input-bar { 
            background: var(--card-bg); padding: 20px; border-radius: 20px; 
            display: grid; grid-template-columns: 2fr 1.2fr 1.1fr 1fr auto; 
            gap: 12px; margin-bottom: 25px; border-bottom: 4px solid var(--primary); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); transition: border-bottom 0.3s;
        }
        
        .input-bar input, .input-bar select {
            padding: 12px; border: 1px solid var(--border); border-radius: 10px; outline: none; font-family: inherit; background: var(--card-bg); color: var(--text);
        }

        .input-bar button { 
            background: var(--primary); color: white; border: none; padding: 0 30px; 
            border-radius: 12px; font-weight: 600; letter-spacing: 1px; cursor: pointer; 
            transition: all 0.2s ease; box-shadow: 0 4px 0 var(--primary-shadow); 
        }

        .board { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 20px; }
        .col { background: var(--col-bg); padding: 18px; border-radius: 24px; min-height: 400px; transition: background 0.3s; }
        
        ul { list-style: none; padding: 0; margin: 0; width: 100%; }
        li { 
            background: var(--card-bg); color: var(--text); padding: 15px; border-radius: 12px; margin-bottom: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-left: 6px solid var(--primary); box-sizing: border-box; width: 100%; 
            transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .btn-icon { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 5px; border-radius: 8px; color: var(--text); opacity: 0.8; }
        .btn-icon:hover { background: var(--col-bg); opacity: 1; }

        @media (max-width: 768px) {
            .input-bar { grid-template-columns: 1fr; }
            .board { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="splash-screen"><h2>MISSION CONTROL PRO</h2></div>

    <div id="app-dashboard">
        <div class="top-nav">
            <button id="theme-toggle" class="btn-header" onclick="toggleTheme()">üåô Dark</button>
            <button id="install-btn" class="btn-header">Install App</button>
            <button class="logout-btn btn-header" onclick="logout()">Sign Out</button>
        </div>

        <div class="analytics-container">
            <div id="status-header" class="analytics-header">Weekly Fuel Levels</div>
            <div class="analytics-content">
                <div class="y-axis"><span id="y-max">8</span><span>6</span><span>4</span><span>2</span><span>0</span></div>
                <div class="chart-area" id="weeklyChart"></div>
                <div class="side-meter">
                    <div class="progress-container">
                        <svg class="progress-ring" width="100" height="100">
                            <circle class="progress-ring-bg" stroke-width="10" fill="transparent" r="42" cx="50" cy="50"/>
                            <circle id="progressCircle" stroke-width="10" fill="transparent" r="42" cx="50" cy="50" style="stroke-dasharray: 264; stroke-dashoffset: 264;"/>
                        </svg>
                        <div id="pctLabel" class="pct-label">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-toggle">
            <button id="view-active" class="view-btn active" onclick="setView('active', event)">ACTIVE</button>
            <button id="view-archived" class="view-btn" onclick="setView('archived', event)">ARCHIVE</button>
        </div>

        <div class="category-bar">
            <button class="cat-tab active" onclick="setCategory('all', event)">ALL</button>
            <button class="cat-tab" onclick="setCategory('work', event)">WORK</button>
            <button class="cat-tab" onclick="setCategory('home', event)">HOME</button>
            <button class="cat-tab" onclick="setCategory('personal', event)">PERSONAL</button>
            <button class="cat-tab" onclick="setCategory('urgent', event)">URGENT</button>
        </div>

        <div class="input-bar">
            <input type="text" id="taskName" placeholder="Mission Name...">
            <select id="taskCat"><option value="work">Work</option><option value="home">Home</option><option value="personal">Personal</option><option value="urgent">Urgent</option></select>
            <input type="date" id="taskDate">
            <input type="time" id="taskTime">
            <button onclick="addTask()">DEPLOY</button>
        </div>

        <div class="board">
            <div class="col"><h3>PREVIOUS</h3><ul id="list-prev"></ul></div>
            <div class="col"><h3>TODAY</h3><ul id="list-today"></ul></div>
            <div class="col"><h3>UPCOMING</h3><ul id="up-cont"></ul></div>
        </div>
    </div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 id="auth-title">Login</h2>
            <div class="auth-input-container"><input type="text" id="username" class="auth-input" placeholder="Username"></div>
            <div class="auth-input-container">
                <input type="password" id="password" class="auth-input" placeholder="Password">
                <button type="button" class="pass-toggle-btn" id="togglePassBtn" onclick="togglePassword()">Show</button>
            </div>
            <button id="authBtn" class="btn-login" onclick="handleAuth()">LOGIN</button>
            <p id="auth-error" style="color:var(--overdue); margin-top:10px; font-size:12px;"></p>
            <p id="toggle-text" style="font-size:12px; margin-top:15px; color:#2d3436;">New user? <span onclick="toggleAuthMode()" style="color:var(--primary); cursor:pointer; font-weight: 600;">Sign Up</span></p>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA-mhIz79hzRvTbVZKeDPEfv2uv5jh-iSA",
        authDomain: "task-list-tracker-e80d4.firebaseapp.com",
        databaseURL: "https://task-list-tracker-e80d4-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "task-list-tracker-e80d4",
        appId: "1:918246411240:web:3f448eb1d0a6fc3f4fb25d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null, allTasks = [], currentCategory = 'all', currentView = 'active', isLoginMode = true;
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW Registered'));
        });
    }

    // --- Connection Monitoring (Offline Sync Logic) ---
    const connectedRef = ref(db, ".info/connected");
    onValue(connectedRef, (snap) => {
        const header = document.getElementById('status-header');
        if (snap.val() === true) {
            header.style.background = "var(--primary)";
            header.innerText = "Weekly Fuel Levels (Online)";
        } else {
            header.style.background = "#e67e22"; // Orange for Sync Pending
            header.innerText = "Weekly Fuel Levels (Sync Pending...)";
        }
    });

    window.toggleTheme = () => {
        const current = document.documentElement.getAttribute('data-theme');
        const target = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', target);
        localStorage.setItem('mission-theme', target);
        document.getElementById('theme-toggle').innerText = target === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
    };

    const savedTheme = localStorage.getItem('mission-theme');
    if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        window.addEventListener('DOMContentLoaded', () => {
             document.getElementById('theme-toggle').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
        });
    }

    let deferredPrompt;
    const installBtn = document.getElementById('install-btn');
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
    });
    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') installBtn.style.display = 'none';
            deferredPrompt = null;
        }
    });

    const initChart = () => {
        const chart = document.getElementById('weeklyChart');
        chart.innerHTML = days.map((day, i) => `
            <div class="bar-wrapper">
                <div class="bar-track">
                    <div id="planned-${i}" class="bar-planned"></div>
                    <div id="done-${i}" class="bar-done"></div>
                </div>
                <div class="day-label">${day}</div>
            </div>`).join('');
    };
    initChart();

    const getTodayStr = () => new Date().toLocaleDateString('en-CA');
    document.getElementById('taskDate').min = getTodayStr();

    onAuthStateChanged(auth, (user) => {
        document.getElementById('splash-screen').classList.add('hidden');
        if (user) { 
            currentUser = user; 
            document.getElementById('auth-screen').style.display = 'none'; 
            document.getElementById('app-dashboard').style.display = 'block'; 
            loadData(); 
        } else { 
            document.getElementById('auth-screen').style.display = 'flex'; 
            document.getElementById('app-dashboard').style.display = 'none'; 
        }
    });

    window.togglePassword = () => {
        const p = document.getElementById('password'), b = document.getElementById('togglePassBtn');
        p.type = p.type === 'password' ? 'text' : 'password';
        b.innerText = p.type === 'password' ? 'Show' : 'Hide';
    };

    window.handleAuth = async () => {
        const u = document.getElementById('username').value, p = document.getElementById('password').value;
        const email = `${u}@missioncontrol.com`;
        try {
            if (isLoginMode) await signInWithEmailAndPassword(auth, email, p);
            else await createUserWithEmailAndPassword(auth, email, p);
        } catch (e) { document.getElementById('auth-error').innerText = e.message; }
    };

    window.toggleAuthMode = () => { 
        isLoginMode = !isLoginMode; 
        document.getElementById('auth-title').innerText = isLoginMode ? "Login" : "Sign Up"; 
        document.getElementById('authBtn').innerText = isLoginMode ? "LOGIN" : "SIGN UP";
        document.getElementById('toggle-text').innerHTML = isLoginMode ? 
            `New user? <span onclick="toggleAuthMode()" style="color:var(--primary); cursor:pointer; font-weight: 600;">Sign Up</span>` :
            `Already have an account? <span onclick="toggleAuthMode()" style="color:var(--primary); cursor:pointer; font-weight: 600;">Login</span>`;
    };

    window.logout = () => signOut(auth);

    window.setView = (view, event) => { 
        currentView = view; 
        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderUI(); 
    };
    
    window.setCategory = (cat, event) => { 
        currentCategory = cat; 
        document.querySelectorAll('.cat-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        renderUI(); 
    };

    function loadData() {
        onValue(ref(db, `users/${currentUser.uid}/tasks`), (snap) => {
            const data = snap.val();
            allTasks = data ? Object.keys(data).map(k => ({id: k, ...data[k]})) : [];
            renderUI();
        });
    }

    window.addTask = () => {
        const n = document.getElementById('taskName').value, d = document.getElementById('taskDate').value, c = document.getElementById('taskCat').value;
        if(!n || !d) return alert("Required fields missing.");
        // Firebase automatically queues this if offline
        set(ref(db, `users/${currentUser.uid}/tasks/${Date.now()}`), { name: n, cat: c, date: d, completed: false, archived: false });
        document.getElementById('taskName').value = '';
        document.getElementById('taskName').focus();
    };

    window.toggleTask = (id, cur) => update(ref(db, `users/${currentUser.uid}/tasks/${id}`), { completed: !cur });
    window.archiveTask = (id, cur) => update(ref(db, `users/${currentUser.uid}/tasks/${id}`), { archived: !cur });
    window.deleteTask = (id) => remove(ref(db, `users/${currentUser.uid}/tasks/${id}`));

    function renderUI() {
        const todayStr = getTodayStr();
        const sun = new Date(); sun.setDate(sun.getDate() - sun.getDay());
        const sunStr = sun.toLocaleDateString('en-CA');

        const prev = document.getElementById('list-prev'), now = document.getElementById('list-today'), up = document.getElementById('up-cont');
        prev.innerHTML = now.innerHTML = up.innerHTML = '';

        let filtered = allTasks.filter(t => currentView === 'archived' ? t.archived : !t.archived);
        if (currentCategory !== 'all') filtered = filtered.filter(t => t.cat === currentCategory);

        const stats = [0,0,0,0,0,0,0], doneStats = [0,0,0,0,0,0,0];

        filtered.forEach(t => {
            const li = document.createElement('li'); 
            li.style.borderLeftColor = `var(--cat-${t.cat})`;
            li.innerHTML = `<div><input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask('${t.id}',${t.completed})">
                <span style="${t.completed ? 'text-decoration: line-through; opacity: 0.5;' : ''}">${t.name}</span></div>
                <div><button class="btn-icon" onclick="archiveTask('${t.id}',${t.archived})" title="Archive">üì•</button>
                <button class="btn-icon" onclick="deleteTask('${t.id}')" title="Delete">üóëÔ∏è</button></div>`;
            
            if (t.date < todayStr) prev.appendChild(li); 
            else if (t.date === todayStr) now.appendChild(li); 
            else up.appendChild(li);

            const tDate = new Date(t.date + 'T00:00:00');
            const diff = Math.round((tDate - new Date(sunStr + 'T00:00:00')) / 86400000);
            if(diff >= 0 && diff < 7) { stats[diff]++; if(t.completed) doneStats[diff]++; }
        });

        const max = Math.max(...stats, 8); 
        document.getElementById('y-max').innerText = max;
        days.forEach((_, i) => {
            const pBar = document.getElementById(`planned-${i}`);
            const dBar = document.getElementById(`done-${i}`);
            if (pBar) pBar.style.height = `${(stats[i]/max)*100}%`;
            if (dBar) dBar.style.height = `${(doneStats[i]/max)*100}%`;
        });

        const total = filtered.length, done = filtered.filter(t => t.completed).length;
        const pct = total ? (done/total)*100 : 0;
        document.getElementById('progressCircle').style.strokeDashoffset = 264 - (pct/100*264);
        document.getElementById('pctLabel').innerText = Math.round(pct) + "%";
    }
</script>
</body>
</html>
