<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mission Control Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #6c5ce7; --secondary: #a29bfe; --overdue: #ff7675; --today: #fab1a0;
            --bg-gradient: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            --glass: rgba(255, 255, 255, 0.9); --text: #2d3436; 
            --cat-work: #0984e3; --cat-home: #6c5ce7; --cat-personal: #00b894; --cat-urgent: #d63031;
        }
        
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; color: var(--text); overflow-x: hidden; }

        /* Auth Screen Styling */
        #auth-screen { 
            display: flex; height: 100vh; width: 100%;
            background: var(--bg-gradient);
            flex-direction: column; align-items: center; justify-content: center;
        }
        .auth-card { 
            background: var(--glass); padding: 40px; border-radius: 24px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.2); width: 340px; text-align: center;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
        }
        .auth-card h2 { margin-bottom: 5px; color: var(--primary); font-weight: 600; }
        .subtitle { font-size: 13px; color: #636e72; margin-bottom: 25px; }
        .auth-input { 
            width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px;
            border: 2px solid transparent; background: #fff; outline: none;
            transition: 0.3s; font-family: inherit; box-sizing: border-box;
        }
        .auth-input:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(108, 92, 231, 0.2); }
        .auth-input.invalid { border-color: var(--overdue); background: #fffafa; }
        .btn-login { 
            background: var(--primary); color: white; border: none; padding: 14px; 
            border-radius: 12px; width: 100%; font-weight: 600; cursor: pointer;
            transition: 0.3s; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-login:disabled { background: #b2bec3; cursor: not-allowed; }
        .toggle-auth { margin-top: 20px; font-size: 13px; color: #2d3436; }
        .toggle-auth span { color: var(--primary); cursor: pointer; font-weight: 600; text-decoration: underline; }

        /* Splash Screen */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: 0.8s; }
        .loader-bar { width: 140px; height: 5px; background: #f1f2f6; border-radius: 10px; margin-top: 20px; overflow: hidden; }
        .loader-progress { width: 30%; height: 100%; background: var(--primary); animation: slide 1.5s infinite linear; }
        @keyframes slide { from { transform: translateX(-100%); } to { transform: translateX(300%); } }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        /* Dashboard & Progress Meter Styles */
        #app-dashboard { display: none; padding: 20px; }
        .header { background: white; padding: 25px; border-radius: 24px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        
        /* Circular Liquid Meter CSS */
        .progress-container { position: relative; width: 80px; height: 80px; }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring__circle {
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            stroke-linecap: round;
            filter: drop-shadow(0 0 5px var(--primary));
        }
        .liquid-flow {
            animation: flow 3s infinite linear;
            stroke-dasharray: 10 5; /* Creates a flow segment look */
        }
        @keyframes flow {
            from { stroke-dashoffset: 200; }
            to { stroke-dashoffset: 0; }
        }
        .pct-label {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px; font-weight: 600; color: var(--primary);
        }

        /* Rest of Dashboard */
        .input-bar { background: white; padding: 20px; border-radius: 20px; display: grid; grid-template-columns: 2fr 1.2fr 1fr 1fr auto; gap: 12px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .board { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 20px; }
        .col { background: #ebedef; padding: 18px; border-radius: 24px; min-height: 450px; }
        li { background: white; padding: 15px; border-radius: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.02); }

        @media (max-width: 900px) { .board, .input-bar { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="splash-screen">
        <svg width="80" height="80" viewBox="0 0 100 100"><rect width="100" height="100" rx="25" fill="#6c5ce7"/><path d="M30 50L45 65L70 35" stroke="white" stroke-width="10" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <div style="margin-top:20px; font-weight:600; letter-spacing:1px; color:var(--primary)">MISSION CONTROL PRO</div>
        <div class="loader-bar"><div class="loader-progress"></div></div>
    </div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 id="auth-title">Welcome Back</h2>
            <p id="auth-subtitle" class="subtitle">Access your productivity command center</p>
            <input type="text" id="username" class="auth-input" placeholder="Callsign (Username)">
            <input type="password" id="password" class="auth-input" placeholder="Secure Password">
            <button id="authBtn" class="btn-login" onclick="handleAuth()">LOGIN</button>
            <p id="auth-error" style="color:var(--overdue); margin-top:15px; font-size: 12px; font-weight:600; line-height:1.4;"></p>
            <div class="toggle-auth">
                <p id="toggle-text">New operative? <span onclick="toggleAuthMode()">Request Access (Sign Up)</span></p>
            </div>
        </div>
        <p style="color:white; font-size:12px; margin-top:20px; opacity:0.8;">System Admin: Ankit, Galgotias University</p>
    </div>

    <div id="app-dashboard">
        <div class="container">
            <div class="header">
                <div>
                    <h2 style="margin:0; font-weight:600;">Command Center</h2>
                    <button onclick="logout()" style="background:none; border:none; color:var(--primary); cursor:pointer; padding:5px 0; font-size:12px; font-weight:600;">Sign Out</button>
                </div>
                
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="text-align: right; line-height: 1;">
                        <div style="font-size: 10px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.5;">Efficiency</div>
                        <div style="font-size: 12px; font-weight: 600; color: var(--primary);">MISSION STATUS</div>
                    </div>
                    <div class="progress-container">
                        <svg class="progress-ring" width="80" height="80">
                            <circle stroke="#e6e6e6" stroke-width="8" fill="transparent" r="32" cx="40" cy="40"/>
                            <circle id="progressCircle" class="progress-ring__circle" stroke="var(--primary)" stroke-width="8" fill="transparent" r="32" cx="40" cy="40" 
                                style="stroke-dasharray: 201.06; stroke-dashoffset: 201.06;"/>
                        </svg>
                        <div id="pctLabel" class="pct-label">0%</div>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:20px; justify-content:center;">
                <button id="btn-active" onclick="setView('active')" style="padding:8px 20px; border-radius:20px; border:none; cursor:pointer; background:var(--primary); color:white; font-weight:600;">ACTIVE</button>
                <button id="btn-archived" onclick="setView('archived')" style="padding:8px 20px; border-radius:20px; border:none; cursor:pointer; background:#fff; color:var(--primary); font-weight:600;">ARCHIVE</button>
            </div>

            <div class="input-bar" id="input-container">
                <input type="text" id="taskName" placeholder="What is the mission?">
                <select id="taskCat">
                    <option value="work">Work</option>
                    <option value="home">Home</option>
                    <option value="personal">Personal</option>
                    <option value="urgent">Urgent</option>
                </select>
                <input type="date" id="taskDate">
                <input type="time" id="taskTime">
                <button class="btn-add" onclick="addTask()" style="background:var(--primary); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:600; padding:10px;">DEPLOY</button>
            </div>

            <div class="board">
                <div class="col"><h3>‚è≥ PREVIOUS</h3><ul id="list-prev"></ul></div>
                <div class="col"><h3>üöÄ TODAY</h3><ul id="list-today"></ul></div>
                <div class="col"><h3>üìÖ UPCOMING</h3><div id="up-cont"></div></div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA-mhIz79hzRvTbVZKeDPEfv2uv5jh-iSA",
        authDomain: "task-list-tracker-e80d4.firebaseapp.com",
        databaseURL: "https://task-list-tracker-e80d4-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "task-list-tracker-e80d4",
        appId: "1:918246411240:web:3f448eb1d0a6fc3f4fb25d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let isLoginMode = true; 
    let currentUser = null, allTasks = [], currentView = 'active';

    window.toggleAuthMode = () => {
        isLoginMode = !isLoginMode;
        document.getElementById('auth-title').innerText = isLoginMode ? "Welcome Back" : "New Commission";
        document.getElementById('authBtn').innerText = isLoginMode ? "LOGIN" : "SIGN UP";
        document.getElementById('toggle-text').innerHTML = isLoginMode ? `New operative? <span onclick="toggleAuthMode()">Request Access (Sign Up)</span>` : `Existing operative? <span onclick="toggleAuthMode()">Authorized Login</span>`;
    };

    onAuthStateChanged(auth, (user) => {
        setTimeout(() => {
            document.getElementById('splash-screen').classList.add('hidden');
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app-dashboard').style.display = 'block';
                loadData();
            } else {
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('app-dashboard').style.display = 'none';
            }
        }, 1200);
    });

    window.handleAuth = async () => {
        const usernameInput = document.getElementById('username'), p = document.getElementById('password').value, errDisplay = document.getElementById('auth-error'), username = usernameInput.value;
        errDisplay.innerText = ""; usernameInput.classList.remove('invalid');
        if(!username || !p) return errDisplay.innerText = "Credentials required.";
        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            usernameInput.classList.add('invalid');
            errDisplay.innerText = "Invalid characters detected. Only letters, numbers, or underscores allowed.";
            return;
        }
        try {
            const virtualEmail = `${username}@missioncontrol.com`;
            if (isLoginMode) await signInWithEmailAndPassword(auth, virtualEmail, p);
            else {
                const check = await get(ref(db, `usernames/${username}`));
                if (check.exists()) throw new Error("Callsign already claimed.");
                const newUser = await createUserWithEmailAndPassword(auth, virtualEmail, p);
                await set(ref(db, `usernames/${username}`), newUser.user.uid);
            }
        } catch (e) { errDisplay.innerText = e.message; }
    };

    window.logout = () => signOut(auth);

    function loadData() {
        onValue(ref(db, `users/${currentUser.uid}/tasks`), (snap) => {
            const data = snap.val();
            allTasks = data ? Object.keys(data).map(k => ({id: k, ...data[k]})) : [];
            renderUI();
        });
    }

    // --- PROGRESS METER LOGIC ---
    function updateProgressMeter(percent) {
        const circle = document.getElementById('progressCircle');
        const label = document.getElementById('pctLabel');
        const radius = circle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        
        const offset = circumference - (percent / 100 * circumference);
        circle.style.strokeDashoffset = offset;
        label.innerText = `${Math.round(percent)}%`;

        // Add "Liquid Flow" animation class if tasks are incomplete
        if (percent > 0 && percent < 100) circle.classList.add('liquid-flow');
        else circle.classList.remove('liquid-flow');
    }

    window.setView = (v) => {
        currentView = v;
        document.getElementById('btn-active').style.background = v === 'active' ? 'var(--primary)' : '#fff';
        document.getElementById('btn-active').style.color = v === 'active' ? '#fff' : 'var(--primary)';
        document.getElementById('btn-archived').style.background = v === 'archived' ? 'var(--primary)' : '#fff';
        document.getElementById('btn-archived').style.color = v === 'archived' ? '#fff' : 'var(--primary)';
        document.getElementById('input-container').style.display = v === 'active' ? 'grid' : 'none';
        renderUI();
    };

    window.addTask = () => {
        const n = document.getElementById('taskName').value, d = document.getElementById('taskDate').value, c = document.getElementById('taskCat').value, t = document.getElementById('taskTime').value;
        if(!n || !d) return alert("Define date.");
        set(ref(db, `users/${currentUser.uid}/tasks/${Date.now()}`), { name: n, cat: c, date: d, time: t, completed: false, archived: false });
        document.getElementById('taskName').value = '';
    };

    window.toggleTask = (id, cur) => update(ref(db, `users/${currentUser.uid}/tasks/${id}`), { completed: !cur });
    window.archiveTask = (id, cur) => update(ref(db, `users/${currentUser.uid}/tasks/${id}`), { archived: !cur, archivedAt: !cur ? Date.now() : null });
    window.deleteTask = (id) => remove(ref(db, `users/${currentUser.uid}/tasks/${id}`));

    function renderUI() {
        const today = new Date().toISOString().split('T')[0];
        const prev = document.getElementById('list-prev'), now = document.getElementById('list-today'), up = document.getElementById('up-cont');
        if(!prev) return;
        prev.innerHTML = now.innerHTML = up.innerHTML = '';
        let tasks = allTasks.filter(t => currentView === 'archived' ? t.archived : !t.archived);
        tasks.sort((a,b) => (a.date+a.time).localeCompare(b.date+b.time)).forEach(t => {
            const li = document.createElement('li');
            li.style.borderLeftColor = `var(--cat-${t.cat})`;
            li.innerHTML = `
                <div style="display:flex;align-items:center;gap:12px;">
                    <input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask('${t.id}', ${t.completed})">
                    <div style="${t.completed?'text-decoration:line-through;opacity:0.4':''}">
                        <b style="font-size:14px;">${t.name}</b><br><small style="font-size:10px;opacity:0.6;">${t.cat.toUpperCase()} | ${t.time || '--:--'}</small>
                    </div>
                </div>
                <div><button onclick="archiveTask('${t.id}', ${t.archived})">${t.archived?'üì§':'üì•'}</button><button onclick="deleteTask('${t.id}')" style="color:var(--overdue)">√ó</button></div>
            `;
            if (t.date < today) prev.appendChild(li); else if (t.date === today) now.appendChild(li); else up.appendChild(li);
        });
        const active = allTasks.filter(t => !t.archived);
        const done = active.filter(t => t.completed).length;
        const pct = active.length ? (done/active.length)*100 : 0;
        updateProgressMeter(pct);
    }
</script>
</body>
</html>
