<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mission Control Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #27ae60; 
            --secondary: #2ecc71;
            --overdue: #e74c3c;
            --bg-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            --glass: rgba(255, 255, 255, 0.95);
            --text: #2d3436; 
            --cat-work: #0984e3; --cat-home: #6c5ce7; --cat-personal: #00b894; --cat-urgent: #d63031;
        }
        
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; color: var(--text); }

        /* Auth Screen */
        #auth-screen { display: flex; height: 100vh; width: 100%; background: var(--bg-gradient); flex-direction: column; align-items: center; justify-content: center; }
        .auth-card { background: var(--glass); padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); width: 340px; text-align: center; }
        .auth-input { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 12px; border: 2px solid #ddd; background: #fff; outline: none; box-sizing: border-box; }
        .btn-login { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: 600; cursor: pointer; text-transform: uppercase; }

        /* Splash */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 9999; transition: 0.8s; }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        /* Dashboard */
        #app-dashboard { display: none; padding: 20px; max-width: 1200px; margin: auto; }
        
        /* ANALYTICS SECTION */
        .analytics-container { background: white; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); overflow: hidden; }
        .analytics-header { background: var(--primary); color: white; padding: 10px 20px; font-weight: 600; text-align: center; font-size: 18px; letter-spacing: 1px; }
        .analytics-content { display: flex; padding: 25px; align-items: flex-end; gap: 30px; }
        .y-axis { display: flex; flex-direction: column; justify-content: space-between; height: 150px; padding-bottom: 25px; color: #636e72; font-size: 12px; font-weight: 600; text-align: right; width: 40px; position: relative; }
        .y-axis-title { position: absolute; left: -35px; top: 50%; transform: rotate(-90deg) translateY(-50%); font-size: 11px; color: #2d3436; }
        .chart-area { flex-grow: 1; display: flex; justify-content: space-between; align-items: flex-end; height: 150px; border-bottom: 2px solid #dfe6e9; padding: 0 10px; position: relative; }
        .grid-line { position: absolute; width: 100%; height: 1px; background: #f1f2f6; left: 0; z-index: 0; }
        .bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; z-index: 1; max-width: 50px; }
        .bar-track { width: 35px; background: #f1f2f6; border-radius: 6px 6px 0 0; position: relative; height: 150px; overflow: hidden; }
        .bar-planned { width: 100%; position: absolute; bottom: 0; background: var(--primary); opacity: 0.25; transition: 0.6s ease; }
        .bar-done { width: 100%; position: absolute; bottom: 0; background: var(--primary); transition: 0.6s ease; }
        .day-label { font-size: 11px; font-weight: 600; margin-top: 10px; color: #2d3436; }

        /* Side Circular Meter */
        .side-meter { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 120px; }
        .progress-container { position: relative; width: 100px; height: 100px; }
        .progress-ring { transform: rotate(-90deg); }
        .progress-ring__circle { transition: stroke-dashoffset 0.8s ease; stroke-linecap: round; }
        .pct-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 22px; font-weight: 600; color: #2d3436; }

        /* VIEW TOGGLE (Active vs Archive) */
        .view-toggle { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; }
        .view-btn { padding: 8px 25px; border-radius: 20px; border: 2px solid var(--primary); background: transparent; color: var(--primary); cursor: pointer; font-weight: 600; transition: 0.3s; }
        .view-btn.active { background: var(--primary); color: white; }

        /* Category Tabs & Input */
        .category-bar { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 5px; }
        .cat-tab { padding: 8px 18px; border-radius: 12px; background: white; border: none; cursor: pointer; font-weight: 600; font-size: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .cat-tab.active { background: #34495e; color: white; }

        .input-bar { background: white; padding: 20px; border-radius: 20px; display: grid; grid-template-columns: 2fr 1.2fr 1.1fr 1fr auto; gap: 12px; margin-bottom: 25px; border-bottom: 4px solid var(--primary); }
        
        /* Board Columns */
        .board { display: grid; grid-template-columns: 1fr 1fr 1.4fr; gap: 20px; }
        .col { background: #ebedef; padding: 18px; border-radius: 24px; min-height: 400px; }
        li { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 6px solid var(--primary); }

        @media (max-width: 900px) { .board, .input-bar, .analytics-content { flex-direction: column; grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="splash-screen">
        <h2 style="color:var(--primary)">MISSION CONTROL PRO</h2>
    </div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2>Welcome Back</h2>
            <input type="text" id="username" class="auth-input" placeholder="Callsign">
            <input type="password" id="password" class="auth-input" placeholder="Password">
            <button id="authBtn" class="btn-login" onclick="handleAuth()">LOGIN</button>
            <p id="auth-error" style="color:var(--overdue); margin-top:10px; font-size:12px;"></p>
            <p style="font-size:12px; margin-top:15px;">New operative? <span onclick="toggleAuthMode()" style="color:var(--primary); cursor:pointer; font-weight: 600;">Join Fleet</span></p>
        </div>
    </div>

    <div id="app-dashboard">
        <div class="analytics-container">
            <div class="analytics-header">Overall Progress</div>
            <div class="analytics-content">
                <div class="y-axis">
                    <span class="y-axis-title">Tasks</span>
                    <span id="y-max">8</span><span>6</span><span>4</span><span>2</span><span>0</span>
                </div>
                <div class="chart-area" id="weeklyChart"></div>
                <div class="side-meter">
                    <div class="progress-container">
                        <svg class="progress-ring" width="100" height="100">
                            <circle stroke="#f1f2f6" stroke-width="10" fill="transparent" r="42" cx="50" cy="50"/>
                            <circle id="progressCircle" class="progress-ring__circle" stroke="var(--primary)" stroke-width="10" fill="transparent" r="42" cx="50" cy="50" style="stroke-dasharray: 264; stroke-dashoffset: 264;"/>
                        </svg>
                        <div id="pctLabel" class="pct-label">0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-toggle">
            <button id="view-active" class="view-btn active" onclick="setView('active')">ACTIVE MISSIONS</button>
            <button id="view-archived" class="view-btn" onclick="setView('archived')">ARCHIVE VAULT</button>
        </div>

        <div class="category-bar">
            <button class="cat-tab active" onclick="setCategory('all')">ALL</button>
            <button class="cat-tab" onclick="setCategory('work')">WORK</button>
            <button class="cat-tab" onclick="setCategory('home')">HOME</button>
            <button class="cat-tab" onclick="setCategory('personal')">PERSONAL</button>
            <button class="cat-tab" onclick="setCategory('urgent')">URGENT</button>
        </div>

        <div class="input-bar" id="inputBarContainer">
            <input type="text" id="taskName" placeholder="New Mission...">
            <select id="taskCat">
                <option value="work">Work</option><option value="home">Home</option><option value="personal">Personal</option><option value="urgent">Urgent</option>
            </select>
            <input type="date" id="taskDate">
            <input type="time" id="taskTime">
            <button onclick="addTask()" style="background:var(--primary); color:white; border:none; border-radius:12px; padding:10px 20px; font-weight:600; cursor:pointer;">DEPLOY</button>
        </div>

        <div class="board">
            <div class="col"><h3>‚è≥ PREVIOUS</h3><ul id="list-prev"></ul></div>
            <div class="col"><h3>üöÄ TODAY</h3><ul id="list-today"></ul></div>
            <div class="col"><h3>üìÖ UPCOMING</h3><div id="up-cont"></div></div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA-mhIz79hzRvTbVZKeDPEfv2uv5jh-iSA",
        authDomain: "task-list-tracker-e80d4.firebaseapp.com",
        databaseURL: "https://task-list-tracker-e80d4-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "task-list-tracker-e80d4",
        appId: "1:918246411240:web:3f448eb1d0a6fc3f4fb25d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null, allTasks = [], currentCategory = 'all', currentView = 'active', isLoginMode = true;

    const getTodayStr = () => new Date().toISOString().split('T')[0];
    document.getElementById('taskDate').min = getTodayStr();

    onAuthStateChanged(auth, (user) => {
        document.getElementById('splash-screen').classList.add('hidden');
        if (user) { currentUser = user; document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-dashboard').style.display = 'block'; loadData(); }
        else { document.getElementById('auth-screen').style.display = 'flex'; document.getElementById('app-dashboard').style.display = 'none'; }
    });

    window.handleAuth = async () => {
        const u = document.getElementById('username'), p = document.getElementById('password').value, err = document.getElementById('auth-error'), username = u.value;
        if (!/^[a-zA-Z0-9_]+$/.test(username)) return err.innerText = "Only letters/numbers/underscores allowed.";
        const email = `${username}@missioncontrol.com`;
        try {
            if (isLoginMode) await signInWithEmailAndPassword(auth, email, p);
            else {
                const check = await get(ref(db, `usernames/${username}`));
                if (check.exists()) throw new Error("Taken.");
                const newUser = await createUserWithEmailAndPassword(auth, email, p);
                await set(ref(db, `usernames/${username}`), newUser.user.uid);
            }
        } catch (e) { err.innerText = e.message; }
    };

    window.toggleAuthMode = () => { isLoginMode = !isLoginMode; document.getElementById('authBtn').innerText = isLoginMode ? "LOGIN" : "SIGN UP"; };
    window.logout = () => signOut(auth);

    // --- VIEW & CATEGORY LOGIC ---
    window.setView = (view) => {
        currentView = view;
        document.getElementById('view-active').classList.toggle('active', view === 'active');
        document.getElementById('view-archived').classList.toggle('active', view === 'archived');
        document.getElementById('inputBarContainer').style.display = view === 'active' ? 'grid' : 'none';
        renderUI();
    };

    window.setCategory = (cat) => {
        currentCategory = cat;
        document.querySelectorAll('.cat-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        renderUI();
    };

    function loadData() {
        onValue(ref(db, `users/${currentUser.uid}/tasks`), (snap) => {
            const data = snap.val();
            allTasks = data ? Object.keys(data).map(k => ({id: k, ...data[k]})) : [];
            renderUI();
        });
    }

    window.addTask = () => {
        const n = document.getElementById('taskName').value, d = document.getElementById('taskDate').value, c = document.getElementById('taskCat').value, t = document.getElementById('taskTime').value;
        if(!n || !d) return alert("Required fields missing.");
        set(ref(db, `users/${currentUser.uid}/tasks/${Date.now()}`), { name: n, cat: c, date: d, time: t, completed: false, archived: false });
        document.getElementById('taskName').value = '';
    };

    window.toggleTask = (id, cur) => update(ref(db, `users/${currentUser.uid}/tasks/${id}`), { completed: !cur });
    window.archiveTask = (id, cur) => update(ref(db, `users/${currentUser.uid}/tasks/${id}`), { archived: !cur });
    window.deleteTask = (id) => remove(ref(db, `users/${currentUser.uid}/tasks/${id}`));

    function getStartOfWeek() {
        const d = new Date();
        const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6 : 1); 
        return new Date(d.setDate(diff)).toISOString().split('T')[0];
    }

    function renderUI() {
        const today = getTodayStr(), startOfWeek = getStartOfWeek();
        const prev = document.getElementById('list-prev'), now = document.getElementById('list-today'), up = document.getElementById('up-cont');
        if(!prev) return;
        prev.innerHTML = now.innerHTML = up.innerHTML = '';

        // 1. Filter by Active/Archive status
        let filtered = allTasks.filter(t => currentView === 'archived' ? t.archived === true : !t.archived);
        
        // 2. Filter by Category
        if (currentCategory !== 'all') {
            filtered = filtered.filter(t => t.cat === currentCategory);
        }

        const stats = [0,0,0,0,0,0,0], doneStats = [0,0,0,0,0,0,0];

        filtered.forEach(t => {
            const li = document.createElement('li');
            li.style.borderLeftColor = `var(--cat-${t.cat})`;
            li.innerHTML = `
                <div style="display:flex;align-items:center;gap:10px;">
                    <input type="checkbox" ${t.completed?'checked':''} onchange="toggleTask('${t.id}', ${t.completed})">
                    <span style="${t.completed?'text-decoration:line-through;opacity:0.4':''}; font-weight:600;">${t.name}</span>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="archiveTask('${t.id}', ${t.archived})" style="background:none; border:none; cursor:pointer; font-size:16px;">${t.archived?'üì§':'üì•'}</button>
                    <button onclick="deleteTask('${t.id}')" style="background:none; border:none; cursor:pointer; color:var(--overdue)">√ó</button>
                </div>`;
            
            if (t.date < today) prev.appendChild(li); else if (t.date === today) now.appendChild(li); else up.appendChild(li);

            const diff = (new Date(t.date) - new Date(startOfWeek)) / (1000 * 60 * 60 * 24);
            if(diff >= 0 && diff < 7) { stats[Math.floor(diff)]++; if(t.completed) doneStats[Math.floor(diff)]++; }
        });

        // Chart Rendering
        const chart = document.getElementById('weeklyChart');
        chart.innerHTML = `<div class="grid-line" style="bottom: 25%;"></div><div class="grid-line" style="bottom: 50%;"></div><div class="grid-line" style="bottom: 75%;"></div>`;
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const max = Math.max(...stats, 8);
        document.getElementById('y-max').innerText = max;

        days.forEach((day, i) => {
            const pHeight = (stats[i] / max) * 100, dHeight = (doneStats[i] / max) * 100;
            chart.innerHTML += `<div class="bar-wrapper"><div class="bar-track"><div class="bar-planned" style="height:${pHeight}%"></div><div class="bar-done" style="height:${dHeight}%"></div></div><div class="day-label">${day}</div></div>`;
        });

        const total = filtered.length, done = filtered.filter(t => t.completed).length;
        const pct = total ? (done/total)*100 : 0;
        document.getElementById('progressCircle').style.strokeDashoffset = 264 - (pct / 100 * 264);
        document.getElementById('pctLabel').innerText = Math.round(pct) + "%";
    }
</script>
</body>
</html>
